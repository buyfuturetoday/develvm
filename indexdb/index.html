<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test IndexDB persistence in the browser</title>
  <link href="http://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.1/normalize.min.css" rel="stylesheet"/>

  <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.15.0.css">

</head>
<body>
	<div id="qunit"></div>
	<div id="qunit-fixture"></div>
	<script src="http://code.jquery.com/qunit/qunit-1.15.0.js"></script>
	<script type="text/javascript">
		QUnit.test( "hello test", function( assert ) {
			assert.ok( 1 == "1", "Passed!" );
		});

	</script>


	<h1>Log</h2>
	<div id="log">Nothing yet<br/></div>

	<script src="http://cdn.jsdelivr.net/pouchdb/3.0.6/pouchdb.min.js"></script>

	<!-- In case the browser does not have IndexDB support -->
	<script src="http://axemclion.github.com/IndexedDBShim/dist/IndexedDBShim.min.js"></script>



	<script type="text/javascript">
		var _doc = {     _id: 'id1'
					   , hello: 'world'
		               , n: 5
		               , today: new Date()
		               , nedbIsAwesome: true
		               , notthere: null
		               , notToBeSaved: undefined  // Will not be saved
		               , fruits: [ 'apple', 'orange', 'pear' ]
		               , infos: { name: 'nedb' }
		               };

		var _docs =  [
		 { _id: 'id1', planet: 'Mars', system: 'solar', inhabited: false, satellites: ['Phobos', 'Deimos'] },
		 { _id: 'id2', planet: 'Earth', system: 'solar', inhabited: true, humans: { genders: 2, eyes: true } },
		 { _id: 'id3', planet: 'Jupiter', system: 'solar', inhabited: false },
		 { _id: 'id4', planet: 'Omicron Persei 8', system: 'futurama', inhabited: true, humans: { genders: 7 } },
		 { _id: 'id5', completeData: { planets: [ { name: 'Earth', number: 3 }, { name: 'Mars', number: 2 }, { name: 'Pluton', number: 9 } ] } }
		 ];

		
		// Define Mobile DB wrapper over IndexDB
		// =====================================

		var mdb = this.mdb || {};

		mdb.indexedDB    = {};
		mdb.indexedDB.db = null;

		var _dbName      = 'mdb';
		var _keyPath     = "timeStamp";


		// Exports
		// =======

		module.exports = mdb;


		// Private functions and properties
		// ================================

		var log = function (msg) {
		  document.getElementById("log").innerHTML += msg + "<br/>";
		  console.log(msg);
		}

		var checkForIndexDBSUpport = function() {
			if (!window.indexedDB) {
			    log("Your browser doesn't support a stable version of IndexedDB. Trying to use a experimental version.");
		    	window.indexedDB = window.indexedDB || window.mozIndexedDB || 
		    						window.webkitIndexedDB || window.msIndexedDB;

				window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
				window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;

				if (!window.indexedDB) {
					log('Experimental version of IndexDB not available. App will exit.')
				    return false;
				  }
			}

			return true;
		}


		// Public part functions and properties
		// =====================================

		// Save value in the database
		// --------------------------

		mdb.put = function(value, oncomplete) {
			log('In mdb.put');

			// everything is performed in transactions
			var trans   = mdb.indexedDB.db.transaction([_dbName], "readwrite");

			// set callback to use when finsihed
			trans.oncomplete = oncomplete;

			var store   = trans.objectStore(_dbName);
			var request = store.put(value);

			request.onerror = function(e) {
				log('In mdb.put - Error: ' + e.value);
			};

		}

		// Run a function over all entries in the table
		// --------------------------------------------

		mdb.processAll = function(fn) {
			log('In mdb.getAll');

			var trans = mdb.indexedDB.db.transaction([_dbName], "readwrite");
			var store = trans.objectStore(_dbName);

			// Get everything in the store;
			var keyRange      = IDBKeyRange.lowerBound(0);
			var cursorRequest = store.openCursor(keyRange);

			cursorRequest.onsuccess = function(e) {
				var result = e.target.result;

				if(!!result == false) {
					return;
				}

				log('In mdb.getAll - result: ' + JSON.stringify(result.value) );

				fn(result.value)

				result.continue();
			};

			cursorRequest.onerror = mdb.indexedDB.onerror;

		}

		// Delete entry with id
		// --------------------

		mdb.delete = function(id) {
			log('In mdb.delete - deleting: ' + id);
			
			var trans = mdb.indexedDB.db.transaction([_dbName], "readwrite");
			var store = trans.objectStore(_dbName);

			var request = store.delete(id);

			trans.oncomplete = function(e) {
				log('In mdb.delete - Finished delete');
			};

			request.onerror = function(e) {
				log('In mdb.delete - Error deleteing: ' + e);
			};

		}

		// Open the IndexDB database and run fn
		// ------------------------------------

		mdb.indexedDB.open = function(fn) {

			if( !checkForIndexDBSUpport() )
				return;

			var version = 1;
			var request = window.indexedDB.open(_dbName, version);

			// We can only create Object stores in a versionchange transaction.
			request.onupgradeneeded = function(e) {
				log('In mdb.indexedDB.open - onupgradeneeded');

				var db = e.target.result;

				// A versionchange transaction is started automatically.
				e.target.transaction.onerror = mdb.indexedDB.onerror;

				// Delete the object store if it exists
				if(db.objectStoreNames.contains(_dbName)) {
					db.deleteObjectStore(_dbName);
				}

				var store = db.createObjectStore(_dbName,
					{keyPath: _keyPath});
			};

			request.onsuccess = function(e) {
				log('In mdb.indexedDB.open - onsuccess');

				mdb.indexedDB.db = e.target.result;

				fn();
			};

			request.onerror = mdb.indexedDB.onerror;

		};

		// Initialize IndexDB
		// ------------------

		mdb.init = function(fn) {
		  mdb.indexedDB.open(fn);
		};


		// Start things
		// =============

		log("Beginning tests");

		var fn = function() {
			mdb.put(
				{
					"text": "todoText",
					"timeStamp" : new Date().getTime()
				},
				function(e) {
					// Put is complete
					log('Transaction complete - process all entries');

					mdb.processAll(function(val) {
						var id = val.timeStamp;
						mdb.delete(id);
					});
				}
			);
		}

		window.addEventListener("DOMContentLoaded", mdb.init(fn), false);

  </script>
</body>
</html>

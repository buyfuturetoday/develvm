<html>
<head>
    <title>Streams in NodeJS</title>
    <meta name="generator" content="DocPad v6.59.6" />
    
</head>
<body>
    <h1>Streams in NodeJS</h1>
<h3>Author: Jonas Colmsjo</h3>
<h3>Date: Sun Jul 21 2013 02:00:00 GMT+0200 (CEST)</h3>
<div><p>Links:</p>
<ul>
<li><a href="https://github.com/substack/stream-handbook">https://github.com/substack/stream-handbook</a></li>
<li><a href="http://nodejs.org/api/stream.html">http://nodejs.org/api/stream.html</a></li>
<li><a href="http://nodejs.org/api/http.html">http://nodejs.org/api/http.html</a></li>
</ul>
<p>First make sure you have an updated version of node: <code>node --version</code> should show at least v.0.10.13.
Use nvm (node version manager) to upgrade node, see: <a href="https://github.com/creationix/nvm">https://github.com/creationix/nvm</a></p>
<h2>Simple exmaple of stream</h2>
<pre><code>var Readable = require(&#39;stream&#39;).Readable;
var rs = Readable();

var c = 97;
rs._read = function () {
    rs.push(String.fromCharCode(c++));
    if (c &gt; &#39;z&#39;.charCodeAt(0) ) rs.push(null);
};

rs.pipe(process.stdout);</code></pre>
<p>The stream is open and will pull new data with <code>_read</code> until is is closed. <code>rs.push(null)</code> closes the stream. The <code>rs._read</code> function that we&#39;ve defined generates one character each time it is called. </p>
<h2>Stream both HTTP request and response</h2>
<p>Write (stream) status to HTTP response as the file is uploaded.</p>
<pre><code>var express = require(&#39;express&#39;);
var app = express();


app.post(&#39;/&#39;, function(req, res){
    var size = 0;

    req.on(&#39;data&#39;, function (data) {
        size += data.length;
        var msg = &#39;Got chunk: &#39; + data.length + &#39; total: &#39; + size;
        console.log(msg);
        res.write(msg+&quot;\n&quot;);
    });

    req.on(&#39;end&#39;, function () {
        var msg = &quot;total size = &quot; + size;
        console.log(msg);
        res.write(msg+&quot;\n&quot;);
        res.end(&quot;Thanks\n&quot;);
    }); 

    req.on(&#39;error&#39;, function(e) {
        var msg = &quot;ERROR ERROR: &quot; + e.message;
        console.log(msg);
        res.write(msg+&quot;\n&quot;);
    });

});

app.listen(3000);
console.log(&#39;Listening on port 3000&#39;);</code></pre>
<p>On the client side:</p>
<ol>
<li>create a tar to send: <code>tar -cf js.tar *.js</code></li>
<li>Test with curl: <code>curl -H &quot;Content-type: application/tar&quot; --data-binary @js.tar http://localhost:3000/</code></li>
</ol>
<p>Now let&#39;s see if we can do the client in JavaScript.</p>
<p>The HTTP request library works with streams:</p>
<ul>
<li><a href="https://github.com/mikeal/request">https://github.com/mikeal/request</a></li>
</ul>
<p>Install the request library in the current directory: <code>npm install request</code></p>
<pre><code>var fs = require(&#39;fs&#39;);
var request = require(&#39;request&#39;);
fs.createReadStream(&#39;js.tar&#39;).pipe(request.post(&#39;http://localhost:3000/&#39;));</code></pre>
<p>This don&#39;t show the status since we don&#39;t handle the reponse at all.</p>
<pre><code>var http = require(&#39;http&#39;);

var options = {
  hostname: &#39;localhost&#39;,
  port: 3000,
  path: &#39;/&#39;,
  method: &#39;POST&#39;
};

var req = http.request(options, function(res) {
  console.log(&#39;STATUS: &#39; + res.statusCode);
  console.log(&#39;HEADERS: &#39; + JSON.stringify(res.headers));

  res.setEncoding(&#39;utf8&#39;);
  res.on(&#39;data&#39;, function (chunk) {
    console.log(&#39;BODY: &#39; + chunk);
  });

});

req.on(&#39;error&#39;, function(e) {
  console.log(&#39;problem with request: &#39; + e.message);
});

// write data to request body
req.write(&#39;data\n&#39;);
req.write(&#39;data\n&#39;);
req.end();</code></pre>
<p>Now we also the the status as the data is sent but we don&#39;t send a file.</p>
<pre><code>var http = require(&#39;http&#39;);

var options = {
  hostname: &#39;localhost&#39;,
  port: 3000,
  path: &#39;/&#39;,
  method: &#39;POST&#39;
};

var req = http.request(options, function(res) {
  console.log(&#39;STATUS: &#39; + res.statusCode);
  console.log(&#39;HEADERS: &#39; + JSON.stringify(res.headers));

  res.setEncoding(&#39;utf8&#39;);
  res.on(&#39;data&#39;, function (chunk) {
    console.log(&#39;BODY: &#39; + chunk);
  });

});

req.on(&#39;error&#39;, function(e) {
  console.log(&#39;problem with request: &#39; + e.message);
});

// write data to the http.ClientRequest (which is a stream) returned by http.request() 
var fs = require(&#39;fs&#39;);
fs.createReadStream(&#39;js.tar&#39;).pipe(req);</code></pre>
<p>Make sure not to call <code>req.end()</code> when using pipes since this will close the stream pre-maturely.</p>
</div>
    
</body>
</html>
